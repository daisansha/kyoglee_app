{% extends "base/accounting_base.html" %}
{% load custom_filters %}
{% block body %}

<div class="contents">
    <h2 class="page_name">{{ cash_page.title }}（{{ cash_page.year }}年）</h2>
    <div class="register_contents">
    <di style="display: flex; gap: 20px; width: 100%;">
        <!-- 左側：出入金管理表 -->
        <div style="flex: 1;">
            <h3>出入金管理表</h3>
            <h4>収入</h4>
            <table border="1" class="member_table">
                <thead><tr><th>日付</th><th>項目</th><th>金額</th></tr></thead>
                <tbody>
                    {% for item in income_items %}
                    <tr>
                        <td>{{ item.date|date:"n/j" }}</td>
                        <td><a href="{% url 'accounting:cash_item_detail' pk=cash_page.id item_id=item.id %}">{{ item.description }}</a></td>
                        <td>{{ item.amount }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row"><td colspan="2"><strong>収入計</strong></td><td>{{ income_total }}</td></tr>
                </tbody>
            </table>

            <h4>支出</h4>
            <table class="member_table" border="1">
                <thead><tr><th>日付</th><th>項目</th><th>金額</th></tr></thead>
                <tbody>
                    {% for item in expense_items %}
                    <tr>
                        <td>{{ item.date|date:"n/j" }}</td>
                        <td><a href="{% url 'accounting:cash_item_detail' pk=cash_page.id item_id=item.id %}">{{ item.description }}</a></td>
                        <td>{{ item.amount }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row"><td colspan="2"><strong>支出計</strong></td><td>{{ expense_total }}</td></tr>
                </tbody>
            </table>

            <h4>総計</h4>
            <table class="member_table" border="1">
                <tr class="total_result"><th>収入計</th><td>{{ income_total }}</td></tr>
                <tr class="total_result"><th>支出計</th><td>{{ expense_total }}</td></tr>
                <tr class="total_result"><th>差額</th><td>{{ balance }}</td></tr>
            </table>
            <button class="button_wrapper">
                <a href="{% url 'accounting:cash_item_add' pk=cash_page.id %}" class="button">出入金項目を追加</a>
            </button>
        </div>
        <!-- 右側：予実管理表 + ボタン -->
        <div style="flex: 1;">
            <h3>予実管理表</h3>
            <h4>予算：{{ cash_page.approval_status }}</h4>

            <table class="member_table" border="1">
                <thead><tr><th>科目</th><th>予算</th><th>実費</th></tr></thead>
                <tbody>
                    <tr><td colspan="3"><strong>収入</strong></td></tr>
                    {% for label in income_labels %}
                    <tr>
                        <td>{{ label }}</td>
                        <td>{{ budget_values|get_item:label|default:0 }}</td>
                        <td>{{ actuals|get_item:label|default:0 }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>収入計</strong></td>
                        <td>{{ income_budget_total }}</td>
                        <td>{{ income_actual_total }}</td>
                    </tr>

                    <tr><td colspan="3"><strong>支出</strong></td></tr>
                    {% for label in expense_labels %}
                    <tr>
                        <td>{{ label }}</td>
                        <td>{{ budget_values|get_item:label|default:0 }}</td>
                        <td>{{ actuals|get_item:label|default:0 }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>支出計</strong></td>
                        <td>{{ expense_budget_total }}</td>
                        <td>{{ expense_actual_total }}</td>
                    </tr>

                    <tr>
                        <td><strong>差額</strong></td>
                        <td>{{ budget_diff }}</td>
                        <td>{{ actual_diff }}</td>
                    </tr>
                </tbody>
            </table>

            <button class="button_wrapper">
                <a href="{% url 'accounting:cash_plan_update' pk=cash_page.id %}" class="button">予算を更新</a>
            </button>
            <button class="button_wrapper">
                <a href="{% url 'accounting:cash_page_delete' pk=cash_page.id %}" class="button">会計表を削除</a>
            </button>
    </div>
</div>

<style>
    .spacious-table th,
    .spacious-table td {
        padding: 8px;
    }

    .total-row td {
        background-color:gainsboro;
    }
    .total_result th{
        background-color:white ;
    }
</style>

<script>
    function sumCells(selector) {
        let total = 0;
        document.querySelectorAll(selector).forEach(cell => {
            let value = parseInt(cell.textContent.trim()) || 0;
            total += value;
        });
        return total;
    }

    function updateTotals() {
        const incomeBudget = sumCells(".budget.income");
        const incomeActual = sumCells(".actual.income");
        const expenseBudget = sumCells(".budget.expense");
        const expenseActual = sumCells(".actual.expense");

        document.getElementById("income-budget-total").textContent = incomeBudget;
        document.getElementById("income-actual-total").textContent = incomeActual;
        document.getElementById("expense-budget-total").textContent = expenseBudget;
        document.getElementById("expense-actual-total").textContent = expenseActual;

        document.getElementById("budget-diff").textContent = incomeBudget - expenseBudget;
        document.getElementById("actual-diff").textContent = incomeActual - expenseActual;
    }

    document.addEventListener("DOMContentLoaded", updateTotals);
</script>


{% endblock %}